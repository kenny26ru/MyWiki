# Kafka

### Что такое Кафка?

Apache Kafka - система обмена сообщениями, для публикации и подписки, разработанная Apache и написанная на Scala. 
Это распределенная*, секционированная** и реплицируемая*** служба журналов. 

`*` **распределенная** система - характеристика системы, которая функционирует через несколько узлов или компонентов, 
работающих одновременно и координирующих свои действия для достижения общей цели. 

`**` **секционированная** система - методика разделения данных на секции или партиции. Это позволяет распределить 
нагрузку и управлять данными более эффективно. Каждая секция может обрабатываться разными узлами или процессами, что 
способствует параллелизму и улучшает производительность.

`***` **реплицируемая** система - свойство системы, позволяющее создавать копии данных или компонентов в нескольких 
местах и узлах. Репликация может использоваться для обеспечения отказоустойчивости, улучшения доступности данных и 
увеличение пропускной способности системы. Копии данных могут автоматически обновляться или синхронизироваться для 
сохранения целостности данных и предоставления быстрого доступа.

<br>

### Традиционные методы передачи сообщений?

Традиционный метод передачи сообщений включает 2 метода: 

- **В очереди**: В очереди пул потребителей может считывать сообщение с сервера, и каждое сообщение будут отправлено
одному из них;
- **Публикация-подписка**: В этой модели сообщения рассылаются всем потребителям. 

Кафка обслуживает единую потребительскую абстракцию, которая обобщает оба вышеперичсленных понятия - группу 
потребителей.

<br>

### В чем преимущество Apache Kafka по сравнению с традиционными методами передачи сообщений?

- **Быстрая**: один брокер Kafka может обслуживать тысячи клиентов, обрабатывая мегабайты операций чтения и записи 
в секунду.
- **Масштабируемая**: Данные секционируются и оптимизируются по кластеру компьютеров, что позволяет хранить большие 
объемы данных.
- **Прочная**: сообщения являются постоянными и реплицируются внутри кластера, чтобы предотвратить потерю данных.
- **Распространяется по дизайну**: обеспечивает гарантии отказоустойчивости и долговечности.

<br>

### Что такое "брокер" в Kafka? 

В кластере Kafka термин "брокер" используется для обозначения сервера. 

<br>

### Какой максимальный размер сообщения может получить сервер Kafka? 

Максимальный размер сообщения составляет 1000000 байт.

<br>

### Что такое Zookeeper в Kafka? Может ли использоваться Kafka без Zookeeper'а? 

Zookeeper - высокопроизводительная служба координации, используемая для распределенных приложений. Невозможно 
подключиться к Kafka напрямую, обойдя Zookeeper.
- Zookeeper используется для связи между узлами в кластере. 
- в Kafka Zookeeper используется для фиксации смещения, поэтому в случае сбоя узла в любом случае можно получить из 
ранее зафиксированного смещения. 
- помимо всего, он выполняет обнаружение лидеров, обеспечивает распределенную синхронизацию, управляет конфигурацией, 
определяет, когда новый узел покидает или присоединяется к кластеру, определяет состояние узлов в реальном времени. 

<br>

### Как сообщения воспринимаются потребителями в Kafka? 

Передача сообщений в Kafka осуществляются с помощью sendfile. Он позволяет передавать байты из сокета на диск 
посредством копий, сохраняющих пространство ядра и осуществлять обратный вызов ядра между пользователями ядра.

<br>

### Как можно улучшить пропускную способность удаленного потребителя? 

Если потребитель находится в центре обработки данных, отличных от брокера, может потребоваться настроить размер буфера 
сокета, что бы амортизировать длительную задержку в сети.

<br>

### Как можно получить только 1 раз сообщение от Kafka во время создания данных?

Во время обработки данных, чтобы получить 1 раз сообщение от Kafka, нужно выполнить 2 вещи: **избежать дублирования** во 
время потребления данных и производстве данных. 2 способа получить 1 семантику: 
1. Доступен 1 модуль для записи каждого раздела. При получении сетевой ошибки, проверяем была ли запись последнего 
сообщения успешной. 
2. В сообщении указать UUID и выполнить дедупликацию* на потребителе. 

`*` **Дедупликация** - это процесс удаления повторяющихся или дублирующихся данных из набора данных или хранилища.

<br>

### Как можно уменьшить отток в ISR? Когда брокер покидает ISR? 

ISR - набор реплик сообщений, которые полностью синхронизированы с лидерами, иначе, ISR содержит все зафиксированные 
сообщения. ISR всегда должен включать реплики, пока не произойдет реальный сбой. Реплика будет исключена из ISR если 
отклонится от лидера. 

<br>

### Зачем нужна репликация в Kafka? 

Репликация сообщений в Kafka гарантирует, что любое опубликованное сообщение не потеряется и может быть использовано 
повторно при ошибки.

<br>

### Расскажите мне о ситуации, когда Кафка — не лучший вариант.

Kafka не лучший вариант если: 
1. **Нужна задержка меньше миллисекунды**. Например, в системе высокоточного трейдинга. Такие системы обычно разработаны
на основе специальных коммерческих решений. 
2. **Нужно реализовать критически важную встроенную систему**. Kafka - не детерминистская система. Такие области как 
управление двигателем, кардиостимулятором или промышленными контроллерами Kafka не подходит.
3. **Есть нестабильные сети**. Для Kafka требуется стабильное сетевое соединение между клиентами и брокерами.
4. **Нужно подключаться к десяткам тысяч клиентов**.
5. **Нужно заменить существующие БД**.
6. **Для обработки больших сообщений**.

<br>


### Как бы вы изменили время удержания в Kafka?

Изменение времени удержания в Kafka зависит от конкретной ситуации и требований приложения. Время удержания определяет 
как долго будет храниться сообщение в теме, до тех пор пока станет недоступным для потребителя. Этот параметр может быть 
изменен для оптимизации производительности.

Что бы изменить параметр, можно воспользоваться инструментами управления темами Kafka Manager или Kafka Tool или 
изменить параметр `retention.ms` в конфигурационных файлах Kafka для определенных тем. По умолчанию `retention.ms` 
установлено на 7 дней(168 часов). 

Для изменения параметра в Kafka CLI можно использовать команду
> bin/kafka-configs.sh --zookeeper localhost:2181 --entity-type topics --entity-name <topic_name> --alter --add-config retention.ms=604800000


### Сравните Apache Kafka с другой популярной потоковой платформой? 

|                                   | Apache Kafka                                                                                                                                                                  | Apache Pulsar                                                                                                                                                                                                                                     |
|-----------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Архитектура                       | Имеет асинхронную модель, основанную на 2 моделях: брокеры Kafka и клиенты Kafka. Брокеры хранят и управляют потоковыми данными, а клиенты публикуют и обрабатывают сообщения | Имеет более гибкую архитектуру, которая включает в себя брокеры, которые являются частью публичного API и брокеры, которые являются частью внутреннего API. Это позволяет Pulsar лучше масштабироваться и предоставлять более высокую доступность |
| Масштабирование                   | Kafka хорошо масштабируется горизонтально, добавляя новые брокеры для увеличения пропускной способности и хранения                                                            | Масштабируется более гибко за счет отделения обработки и хранения, что позволяет масштабировать оба компонента независимо друг от друга                                                                                                           |
| Точность гарантированной доставки | Kafka предоставляет строгую семантику доставки сообщения в том порядке, в котором они были отправлены                                                                         | Обеспечивает гарантированную доставку сообщений с возможностью настройки уровня (от низкой до строгой)                                                                                                                                            |
| Хранение и управление данными     | Хранит данные на диске, что обеспечивает устойчивость к сбоям, но может снижаться производительность при записи                                                               | Имеет более гибкую модель хранения данных, позволяя выбирать между хранением на диске и в памяти                                                                                                                                                  |
| Экосистема                        | Обладает богатой экосистемой инструментов и библиотек, таких как Kafka Streams для обработки потоков данных, Kafka Connect для интеграции с внешними системами                | Имеет разнообразные интеграции и инструменты, но не так широка экосистема, как у Kafka                                                                                                                                                            |

<br>

### Когда бы вы использовали функцию кластера в Kafka?

Функция кластера в Kafka предназначена для обеспечения высокой доступности и отказоустойчивости Kafka-окружения.
Использование кластера Kafka допустимо, когда: 

1. Нужна высокая доступность данных
    - кластер Kafka позволяет распределить данные по нескольким брокерам(узлам), 



Как разбалансировать кластер в Kafka?
Что бы вы сделали, если бы при использовании Kafka возникла ошибка?
Как бы вы получили одно сообщение от Кафки во время производства данных?
Что вы имеете в виду, когда говорите «отказоустойчивость»?
Как бы вы интегрировали Kafka с другими фреймворками?